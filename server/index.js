// ================= –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–ï–†–í–ï–†–ê =================

// –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
const express = require('express'); // –§—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
const http = require('http');       // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –º–æ–¥—É–ª—å Node.js –¥–ª—è HTTP (–ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è Socket.io)
const { Server } = require("socket.io"); // –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –¥–ª—è –≤–µ–±-—Å–æ–∫–µ—Ç—ñ–≤ (real-time –∑–≤'—è–∑–æ–∫)
const cors = require('cors');       // –î–æ–∑–≤–æ–ª—è—î –∑–∞–ø–∏—Ç–∏ –∑ —ñ–Ω—à–∏—Ö –¥–æ–º–µ–Ω—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑ —Ç–≤–æ–≥–æ React –Ω–∞ localhost:3000)

const app = express();
app.use(cors()); // –î–æ–∑–≤–æ–ª—è—î–º–æ –≤—Å—ñ–º —Å—Ç—É–∫–∞—Ç–∏—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä

// –°—Ç–≤–æ—Ä—é—î–º–æ HTTP —Å–µ—Ä–≤–µ—Ä –Ω–∞ –±–∞–∑—ñ Express
const server = http.createServer(app);

// –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ Socket.io
const io = new Server(server, {
    cors: { 
        origin: "*", // –î–æ–∑–≤–æ–ª—è—î–º–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑ –±—É–¥—å-—è–∫–æ–≥–æ —Å–∞–π—Ç—É/–ø–æ—Ä—Ç—É
        methods: ["GET", "POST"] 
    }
});

// ================= –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü –¢–ê –•–ï–õ–ü–ï–†–ò =================

const ROUND_TIME = 60; // –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Ä–∞—É–Ω–¥—É –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

// "–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö" —É –ø–∞–º'—è—Ç—ñ. 
// –ö–ª—é—á - ID –∫—ñ–º–Ω–∞—Ç–∏ (–Ω–∞–ø—Ä. 'X7A1'), –ó–Ω–∞—á–µ–Ω–Ω—è - –æ–±'—î–∫—Ç –∑ –¥–∞–Ω–∏–º–∏ –≥—Ä–∏.
// –£–í–ê–ì–ê: –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å–µ—Ä–≤–µ—Ä–∞ –≤—Å—ñ –∫—ñ–º–Ω–∞—Ç–∏ –∑–Ω–∏–∫–Ω—É—Ç—å.
const rooms = {};

// –ì–µ–Ω–µ—Ä—É—î –≤–∏–ø–∞–¥–∫–æ–≤–∏–π –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ –∑ 4 —Å–∏–º–≤–æ–ª—ñ–≤ (–Ω–∞–ø—Ä. "A1B2")
function generateRoomId() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 4; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// –ê–ª–≥–æ—Ä–∏—Ç–º –ø–µ—Ä–µ–º—ñ—à—É–≤–∞–Ω–Ω—è –º–∞—Å–∏–≤—É (Fisher-Yates shuffle)
// –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —â–æ–± —Å–ª–æ–≤–∞ –≤–∏–ø–∞–¥–∞–ª–∏ —É –≤–∏–ø–∞–¥–∫–æ–≤–æ–º—É –ø–æ—Ä—è–¥–∫—É
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// --- –§–£–ù–ö–¶–Ü–Ø –ë–ï–ó–ü–ï–ö–ò ---
// –í–æ–Ω–∞ –ø—Ä–∏–±–∏—Ä–∞—î "—Å–µ–∫—Ä–µ—Ç–Ω—ñ" –¥–∞–Ω—ñ –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é –Ω–∞ –∫–ª—ñ—î–Ω—Ç.
// –ö–ª—ñ—î–Ω—Ç—É –Ω–µ —Ç—Ä–µ–±–∞ –∑–Ω–∞—Ç–∏ –ø–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫ —Å–ª—ñ–≤ (deck), —â–æ–± –Ω–µ –ø—ñ–¥–≥–ª—è–¥–∞—Ç–∏ —á–µ—Ä–µ–∑ DevTools,
// —ñ –Ω–µ —Ç—Ä–µ–±–∞ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ –æ–±'—î–∫—Ç–∏ —Ç–∞–π–º–µ—Ä—ñ–≤.
function getSafeRoom(room) {
    // –î–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü—ñ—è: –≤–∏—Ç—è–≥—É—î–º–æ deleteTimeout, timer, deck –≤ –æ–∫—Ä–µ–º—ñ –∑–º—ñ–Ω–Ω—ñ (—ñ —ñ–≥–Ω–æ—Ä—É—î–º–æ —ó—Ö),
    // –∞ –≤—Å–µ —ñ–Ω—à–µ –∑–±–∏—Ä–∞—î–º–æ –≤ –æ–±'—î–∫—Ç safeData.
    const { deleteTimeout, timer, deck, ...safeData } = room;
    return safeData;
}

// ================= –û–°–ù–û–í–ù–ê –õ–û–ì–Ü–ö–ê SOCKET.IO =================

// –¶—è —Ñ—É–Ω–∫—Ü—ñ—è —Å–ø—Ä–∞—Ü—å–æ–≤—É—î –ö–û–ñ–ù–û–ì–û —Ä–∞–∑—É, –∫–æ–ª–∏ —Ö—Ç–æ—Å—å –≤—ñ–¥–∫—Ä–∏–≤–∞—î —Å—Ç–æ—Ä—ñ–Ω–∫—É —ñ –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è
io.on('connection', (socket) => { 
    console.log(`User connected: ${socket.id}`); // socket.id - —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (–∑–º—ñ–Ω—é—î—Ç—å—Å—è –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏)

    // --- 1. –°–¢–í–û–†–ï–ù–ù–Ø –ö–Ü–ú–ù–ê–¢–ò ---
    socket.on("create_room", () => {
        let roomId = generateRoomId();
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∫–æ–ª—ñ–∑—ñ—ó: —è–∫—â–æ —Ç–∞–∫–∏–π ID –≤–∂–µ —î, –≥–µ–Ω–µ—Ä—É—î–º–æ –Ω–æ–≤–∏–π
        while (rooms[roomId]) {
            roomId = generateRoomId();
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É –Ω–æ–≤–æ—ó –≥—Ä–∏
        rooms[roomId] = {
            team1: [],          // –ì—Ä–∞–≤—Ü—ñ –∫–æ–º–∞–Ω–¥–∏ 1
            team2: [],          // –ì—Ä–∞–≤—Ü—ñ –∫–æ–º–∞–Ω–¥–∏ 2
            score: { 1: 0, 2: 0 }, // –ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫ –≥—Ä–∏
            roundScore: 0,      // –†–∞—Ö—É–Ω–æ–∫ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ä–∞—É–Ω–¥—É
            roundHistory: [],   // –Ü—Å—Ç–æ—Ä—ñ—è —Å–ª—ñ–≤ –∑–∞ —Ä–∞—É–Ω–¥ (–¥–ª—è –µ–∫—Ä–∞–Ω—É Review)
            currentTeam: 1,     // –•—Ç–æ –∑–∞—Ä–∞–∑ —Ö–æ–¥–∏—Ç—å
            status: 'lobby',    // –°—Ç–∞—Ç—É—Å–∏: 'lobby', 'game', 'review'
            deck: [],           // –ö–æ–ª–æ–¥–∞ —Å–ª—ñ–≤ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ—ó –≥—Ä–∏
            currentWord: null,  // –°–ª–æ–≤–æ, —è–∫–µ –∑–∞—Ä–∞–∑ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ
            timer: null,        // –¢–µ—Ö–Ω—ñ—á–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è setInterval
            timeLeft: ROUND_TIME, // –ß–∞—Å, —â–æ –∑–∞–ª–∏—à–∏–≤—Å—è
            deleteTimeout: null // –¢–∞–π–º–µ—Ä –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏, —è–∫—â–æ –≤—Å—ñ –≤–∏–π—à–ª–∏
        };

        socket.join(roomId); // –ü—ñ–¥–ø–∏—Å—É—î–º–æ —Ü–µ–π —Å–æ–∫–µ—Ç –Ω–∞ –ø–æ–¥—ñ—ó —Ü—ñ—î—ó –∫—ñ–º–Ω–∞—Ç–∏
        socket.emit("room_created", roomId); // –ö–∞–∂–µ–º–æ –∫–ª—ñ—î–Ω—Ç—É: "–ì–æ—Ç–æ–≤–æ, –æ—Å—å —Ç–≤—ñ–π ID"
    });

    // --- 2. –í–•–Ü–î –£ –ö–Ü–ú–ù–ê–¢–£ ---
    socket.on("join_room", (roomId) => {
        const room = rooms[roomId];
        if (room) {
            // –Ø–∫—â–æ –∫—ñ–º–Ω–∞—Ç–∞ –±—É–ª–∞ –ø–æ–º—ñ—á–µ–Ω–∞ –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è (–±–æ –±—É–ª–∞ –ø–æ—Ä–æ–∂–Ω—è), —Å–∫–∞—Å–æ–≤—É—î–º–æ —Ü–µ.
            // –õ—é–¥–∏ –ø–æ–≤–µ—Ä–Ω—É–ª–∏—Å—è!
            if (room.deleteTimeout) {
                clearTimeout(room.deleteTimeout);
                room.deleteTimeout = null;
                console.log(`üóëÔ∏è‚ùå –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏ ${roomId} —Å–∫–∞—Å–æ–≤–∞–Ω–æ.`);
            }

            socket.join(roomId); // –î–æ–¥–∞—î–º–æ —Å–æ–∫–µ—Ç —É "—á–∞—Ç" –∫—ñ–º–Ω–∞—Ç–∏
            
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∫–ª—ñ—î–Ω—Ç—É –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –∫—ñ–º–Ω–∞—Ç–∏ (–±–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω–∏—Ö –ø–æ–ª—ñ–≤)
            socket.emit("update_teams", getSafeRoom(room));
            socket.emit("update_score", room.score); 
            
            // –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É (Reconnection):
            // –Ø–∫—â–æ –≥—Ä–∞–≤–µ—Ü—å –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤ —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—ñ–¥ —á–∞—Å –≥—Ä–∏, –º–∏ –≤—ñ–¥—Ä–∞–∑—É –ø–æ–∫–∞–∑—É—î–º–æ –π–æ–º—É –≥—Ä—É.
            if (room.status === 'game') {
                 if (room.currentWord) socket.emit("game_started", room.currentWord);
                 socket.emit("timer_update", room.timeLeft);
            }
            // –Ø–∫—â–æ –ø—ñ–¥ —á–∞—Å —Ä–µ–≤'—é - –ø–æ–∫–∞–∑—É—î–º–æ —Ä–µ–≤'—é
            if (room.status === 'review') {
                socket.emit("round_ended", room.roundHistory);
            }
        }
    });

    // --- 3. –°–¢–ê–†–¢ –†–ê–£–ù–î–£ ---
    socket.on("request_start", ({roomId}) => {
        const room = rooms[roomId];
        if (room) {
            // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞—Ä–∏–π —Ç–∞–π–º–µ—Ä, —è–∫—â–æ –≤—ñ–Ω —Ä–∞–ø—Ç–æ–º –±—É–≤
            if (room.timer) clearInterval(room.timer);

            // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è —Å—Ç–∞—Ä—Ç—É
            room.status = 'game';
            room.roundHistory = []; 
            room.roundScore = 0;    
            
            // –¢–∏–º—á–∞—Å–æ–≤–∏–π —Å–ø–∏—Å–æ–∫ —Å–ª—ñ–≤ (–ø–æ—Ç—ñ–º —Ç–∏ –∑–∞–º—ñ–Ω–∏—à —Ü–µ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–∏—Ö –∞–±–æ JSON)
            const wordsList = ["–ö–∏—ó–≤", "–Ø–±–ª—É–∫–æ", "–ó–µ–ª–µ–Ω—Å—å–∫–∏–π", "–ö–æ–¥", "–ú–∞—à–∏–Ω–∞", "–°–æ–Ω—Ü–µ", "–ö–∞–≤–∞", "–ö—ñ—Ç", "–Ü–Ω—Ç–µ—Ä–Ω–µ—Ç", "–†–µ–∞–∫—Ç–æ—Ä", "–ë–æ—Ä—â", "–°–∞–ª–æ", "–ú—Ä—ñ—è", "–î–Ω—ñ–ø—Ä–æ"]; 
            
            // –ö–æ–ø—ñ—é—î–º–æ —ñ –ø–µ—Ä–µ–º—ñ—à—É—î–º–æ —Å–ª–æ–≤–∞
            room.deck = shuffleArray([...wordsList]); 
            
            // –ë–µ—Ä–µ–º–æ –ø–µ—Ä—à–µ —Å–ª–æ–≤–æ
            const firstWord = room.deck.pop();
            room.currentWord = firstWord; 
            room.timeLeft = ROUND_TIME;

            // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ –í–°–Ü–• —É –∫—ñ–º–Ω–∞—Ç—ñ, —â–æ –≥—Ä–∞ –ø–æ—á–∞–ª–∞—Å—è
            io.to(roomId).emit("game_started", firstWord);
            io.to(roomId).emit("timer_update", room.timeLeft);

            // –ó–ê–ü–£–°–ö –¢–ê–ô–ú–ï–†–ê –ù–ê –°–ï–†–í–ï–†–Ü
            // –°–µ—Ä–≤–µ—Ä - –¥–∂–µ—Ä–µ–ª–æ –ø—Ä–∞–≤–¥–∏ –ø—Ä–æ —á–∞—Å.
            room.timer = setInterval(() => {
                room.timeLeft--; 
                io.to(roomId).emit("timer_update", room.timeLeft); // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ —á–∞—Å –∑ –∫–ª—ñ—î–Ω—Ç–∞–º–∏

                // –ö–æ–ª–∏ —á–∞—Å –≤–∏–π—à–æ–≤
                if (room.timeLeft <= 0) {
                    clearInterval(room.timer); // –ó—É–ø–∏–Ω—è—î–º–æ –≥–æ–¥–∏–Ω–Ω–∏–∫
                    room.status = 'review';    // –ó–º—ñ–Ω—é—î–º–æ —Å—Ç–∞—Ç—É—Å –Ω–∞ "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–ª—ñ–≤"
                    
                    // –î–æ–¥–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—î —Å–ª–æ–≤–æ –≤ —ñ—Å—Ç–æ—Ä—ñ—é —è–∫ "–Ω–µ –≤–≥–∞–¥–∞–Ω–µ" (none), 
                    // —â–æ–± –≥—Ä–∞–≤—Ü—ñ –≤–∏—Ä—ñ—à–∏–ª–∏, –∑–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ –π–æ–≥–æ —á–∏ –Ω—ñ
                    if (room.currentWord) {
                        room.roundHistory.push({ word: room.currentWord, status: 'none' });
                    }
                    console.log(`–ö—ñ–º–Ω–∞—Ç–∞ ${roomId}: –ß–∞—Å –≤–∏–π—à–æ–≤ -> Review.`);
                    io.to(roomId).emit("round_ended", room.roundHistory);
                }
            }, 1000); // –¢—ñ–∫–∞—î –∫–æ–∂–Ω—É —Å–µ–∫—É–Ω–¥—É (1000 –º—Å)
        }
    });

    // --- 4. –û–ë–†–û–ë–ö–ê –°–õ–Ü–í (–í–≥–∞–¥–∞–≤ / –ü—Ä–æ–ø—É—Å—Ç–∏–≤) ---
    socket.on("next_word", ({roomId, action}) => {
        const room = rooms[roomId];
        // –ü—Ä–∏–π–º–∞—î–º–æ –∫–æ–º–∞–Ω–¥–∏ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –π–¥–µ –≥—Ä–∞
        if (room && room.status === 'game') {
            // –ó–∞–ø–∏—Å—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ —Å–ª–æ–≤–∞
            room.roundHistory.push({ word: room.currentWord, status: action });
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π —Ä–∞—Ö—É–Ω–æ–∫ —Ä–∞—É–Ω–¥—É
            if (action === 'guessed') room.roundScore++;
            if (action === 'skipped') room.roundScore--;

            // –†–∞—Ö—É—î–º–æ "–∂–∏–≤–∏–π" —Ä–∞—Ö—É–Ω–æ–∫, —â–æ–± –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –¥–∏–Ω–∞–º—ñ–∫—É, –∞–ª–µ —â–µ –Ω–µ –∑–∞–ø–∏—Å—É—î–º–æ –π–æ–≥–æ "–Ω–∞–≤—ñ—á–Ω–æ"
            const liveScore = { ...room.score };
            liveScore[room.currentTeam] += room.roundScore;
            io.to(roomId).emit("update_score", liveScore);

            // –Ø–∫—â–æ —Å–ª–æ–≤–∞ —â–µ —î
            if (room.deck.length > 0) {
                const nextWord = room.deck.pop();
                room.currentWord = nextWord;
                io.to(roomId).emit("update_word", nextWord);
            } else {
                // –Ø–∫—â–æ —Å–ª–æ–≤–∞ –∑–∞–∫—ñ–Ω—á–∏–ª–∏—Å—å —Ä–∞–Ω—ñ—à–µ —á–∞—Å—É - –∫—ñ–Ω–µ—Ü—å —Ä–∞—É–Ω–¥—É
                clearInterval(room.timer);
                room.status = 'review';
                io.to(roomId).emit("round_ended", room.roundHistory);
            }
        }
    });

    // --- 5. –ü–Ü–î–¢–í–ï–†–î–ñ–ï–ù–ù–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–Ü–í (–ï–∫—Ä–∞–Ω Review) ---
    socket.on("confirm_round_results", ({roomId, finalHistory}) => {
        const room = rooms[roomId];
        if (room) {
            // –ü–µ—Ä–µ—Ä–∞—Ö–æ–≤—É—î–º–æ –±–∞–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É 
            // (–±–æ –≥—Ä–∞–≤—Ü—ñ –º–æ–≥–ª–∏ –∑–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å–∏ —Å–ª—ñ–≤ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ Review)
            let finalRoundPoints = 0;
            finalHistory.forEach(item => {
                if (item.status === 'guessed') finalRoundPoints += 1;
                if (item.status === 'skipped') finalRoundPoints -= 1;
            });

            // –û–Ω–æ–≤–ª—é—î–º–æ –ì–õ–û–ë–ê–õ–¨–ù–ò–ô —Ä–∞—Ö—É–Ω–æ–∫ –≥—Ä–∏
            room.score[room.currentTeam] += finalRoundPoints;
            
            // –ú—ñ–Ω—è—î–º–æ –∫–æ–º–∞–Ω–¥—É (–±—É–ª–∞ 1 -> —Å—Ç–∞–ª–∞ 2, –±—É–ª–∞ 2 -> —Å—Ç–∞–ª–∞ 1)
            room.currentTeam = room.currentTeam === 1 ? 2 : 1;
            room.status = 'lobby'; 

            console.log(`–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ù–æ–≤–∏–π —Ä–∞—Ö—É–Ω–æ–∫:`, room.score);

            io.to(roomId).emit("update_score", room.score);
            io.to(roomId).emit("results_confirmed"); // –ü–æ–≤–µ—Ä—Ç–∞—î –∫–ª—ñ—î–Ω—Ç—ñ–≤ —É –ª–æ–±—ñ
        }
    });

    // --- 6. –ü–†–ò–Ñ–î–ù–ê–ù–ù–Ø –î–û –ö–û–ú–ê–ù–î–ò ---
    socket.on("join_team", ({ roomId, team, name }) => {
        const room = rooms[roomId];
        if (room) {
            // –í–∞–ª—ñ–¥–∞—Ü—ñ—è: —ñ–º'—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø—É—Å—Ç–∏–º
            if (!name || !name.trim()) return;

            // –ö–†–û–ö 1: –û—á–∏—Å—Ç–∫–∞. 
            // –Ø–∫—â–æ —Ü–µ–π –≥—Ä–∞–≤–µ—Ü—å –≤–∂–µ –±—É–≤ –¥–µ—Å—å –∑–∞–ø–∏—Å–∞–Ω–∏–π (–Ω–∞–≤—ñ—Ç—å –≤ —ñ–Ω—à—ñ–π –∫–æ–º–∞–Ω–¥—ñ) - –≤–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π –∑–∞–ø–∏—Å.
            // –¶–µ –∑–∞—Ö–∏—â–∞—î –≤—ñ–¥ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤ –ø—Ä–∏ –±–∞–≥–∞—Ç–æ—Ä–∞–∑–æ–≤–∏—Ö –∫–ª—ñ–∫–∞—Ö.
            room.team1 = room.team1.filter(p => p.id !== socket.id && p.name !== name);
            room.team2 = room.team2.filter(p => p.id !== socket.id && p.name !== name);

            // –ö–†–û–ö 2: –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç –≥—Ä–∞–≤—Ü—è
            const newPlayer = { id: socket.id, name: name };

            // –ö–†–û–ö 3: –î–æ–¥–∞—î–º–æ —É –≤–∏–±—Ä–∞–Ω—É –∫–æ–º–∞–Ω–¥—É
            const teamId = Number(team); 

            if (teamId === 1) {
                room.team1.push(newPlayer);
            } else if (teamId === 2) {
                room.team2.push(newPlayer);
            } else {
                console.log(`‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞: –Ω–µ–≤—ñ–¥–æ–º–∞ –∫–æ–º–∞–Ω–¥–∞ ${team} –≤—ñ–¥ –≥—Ä–∞–≤—Ü—è ${name}`);
            }
            
            // –ö–†–û–ö 4: –í—Å—ñ–º —É –∫—ñ–º–Ω–∞—Ç—ñ —Ä–æ–∑—Å–∏–ª–∞—î–º–æ –Ω–æ–≤–∏–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
            io.to(roomId).emit("update_teams", getSafeRoom(room));
        }
    });

    // --- 7. –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø (DISCONNECT) ---
    // –ù–∞–π—Å–∫–ª–∞–¥–Ω—ñ—à–∞ —á–∞—Å—Ç–∏–Ω–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–ª–µ–º—É "F5" (–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏)
    socket.on('disconnect', () => {
        // –ú–∏ –ù–ï –≤–∏–¥–∞–ª—è—î–º–æ –≥—Ä–∞–≤—Ü—è –º–∏—Ç—Ç—î–≤–æ.
        // –ö–æ–ª–∏ —Ç–∏ —Ç–∏—Å–Ω–µ—à F5, —Å–æ–∫–µ—Ç —Ä–æ–∑—Ä–∏–≤–∞—î—Ç—å—Å—è, —ñ –∑–∞ —Å–µ–∫—É–Ω–¥—É —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –Ω–æ–≤–∏–π.
        // –Ø–∫—â–æ –≤–∏–¥–∞–ª—è—Ç–∏ –≤—ñ–¥—Ä–∞–∑—É, –≥—Ä–∞–≤–µ—Ü—å "–±–ª–∏–º–Ω–µ" —ñ –∑–Ω–∏–∫–Ω–µ –∑—ñ —Å–ø–∏—Å–∫—É.
        
        setTimeout(() => {
            for (const roomId in rooms) {
                const room = rooms[roomId];
                if (!room) continue;

                // –ó–±–∏—Ä–∞—î–º–æ ID –≤—Å—ñ—Ö –≥—Ä–∞–≤—Ü—ñ–≤, —è–∫—ñ –∑–∞–ø–∏—Å–∞–Ω—ñ –≤ –∫–æ–º–∞–Ω–¥–∞—Ö
                const team1Ids = room.team1.map(p => p.id);
                const team2Ids = room.team2.map(p => p.id);
                const allPlayerIds = [...team1Ids, ...team2Ids];

                // –Ø–∫—â–æ ID —Å–æ–∫–µ—Ç–∞, —â–æ –≤—ñ–¥–∫–ª—é—á–∏–≤—Å—è (socket.id), –≤—Å–µ —â–µ —î –≤ —Å–ø–∏—Å–∫–∞—Ö –∫–æ–º–∞–Ω–¥–∏...
                // –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –∑–∞ 5 —Å–µ–∫—É–Ω–¥ –≤—ñ–Ω –ù–ï –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–∏–≤—Å—è (–Ω–µ –∑–∞–º—ñ–Ω–∏–≤ —Å—Ç–∞—Ä–∏–π ID –Ω–æ–≤–∏–º —á–µ—Ä–µ–∑ join_team).
                // –ó–Ω–∞—á–∏—Ç—å, –≤—ñ–Ω —Ä–µ–∞–ª—å–Ω–æ –ø—ñ—à–æ–≤.
                if (allPlayerIds.includes(socket.id)) {
                    room.team1 = room.team1.filter(p => p.id !== socket.id);
                    room.team2 = room.team2.filter(p => p.id !== socket.id);
                    // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–∫–∏ –¥–ª—è —Ç–∏—Ö, —Ö—Ç–æ –∑–∞–ª–∏—à–∏–≤—Å—è
                    io.to(roomId).emit("update_teams", getSafeRoom(room));
                }

                // –õ–æ–≥—ñ–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ—Ä–æ–∂–Ω—å–æ—ó –∫—ñ–º–Ω–∞—Ç–∏
                if (room.team1.length === 0 && room.team2.length === 0) {
                    if (room.timer) clearInterval(room.timer); // –ó—É–ø–∏–Ω—è—î–º–æ –≥—Ä—É, —è–∫—â–æ –≤–æ–Ω–∞ –π—à–ª–∞
                    
                    // –°—Ç–∞–≤–∏–º–æ —Ç–∞–π–º–µ—Ä –Ω–∞ –æ—Å—Ç–∞—Ç–æ—á–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏ —á–µ—Ä–µ–∑ 30 —Å–µ–∫
                    if (!room.deleteTimeout) {
                        console.log(`‚è≥ –ö—ñ–º–Ω–∞—Ç–∞ ${roomId} –ø–æ—Ä–æ–∂–Ω—è. –í–∏–¥–∞–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 30 —Å–µ–∫...`);
                        room.deleteTimeout = setTimeout(() => {
                            // –ü–æ–¥–≤—ñ–π–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫: —Ä–∞–ø—Ç–æ–º —Ö—Ç–æ—Å—å –∑–∞–π—à–æ–≤?
                            if (rooms[roomId] && rooms[roomId].team1.length === 0 && rooms[roomId].team2.length === 0) {
                                delete rooms[roomId]; // –í–∏–¥–∞–ª—è—î–º–æ –∑ –ø–∞–º'—è—Ç—ñ —Å–µ—Ä–≤–µ—Ä–∞
                                console.log(`üóëÔ∏è –ö—ñ–º–Ω–∞—Ç–∞ ${roomId} –æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–∞.`);
                            } else {
                                // –Ø–∫—â–æ —Ö—Ç–æ—Å—å –∑–∞–π—à–æ–≤, —Å–∫–∞—Å–æ–≤—É—î–º–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
                                if(rooms[roomId]) rooms[roomId].deleteTimeout = null;
                            }
                        }, 30000);
                    }
                }
            }
        }, 5000); // –ß–µ–∫–∞—î–º–æ 5 —Å–µ–∫—É–Ω–¥ (Grace period)
    });

});

// –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É–≤–∞–Ω–Ω—è –ø–æ—Ä—Ç—É
server.listen(3001, () => {
    console.log('SERVER STARTED ON 3001');
});